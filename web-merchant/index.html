<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Merchant - เพิ่มเมนู</title>
  <link rel="stylesheet" href="../theme/theme.css" />
  <meta name="color-scheme" content="light dark">
</head>
<body>
  <main class="card">
    <div class="header">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <!-- fork -->
          <path d="M7 2c.55 0 1 .45 1 1v5a1 1 0 1 1-2 0V3c0-.55.45-1 1-1zm3 0c.55 0 1 .45 1 1v5a1 1 0 1 1-2 0V3c0-.55.45-1 1-1zm-5 6c.55 0 1 .45 1 1v11a1 1 0 1 1-2 0V9c0-.55.45-1 1-1zm7.5-3.5A2.5 2.5 0 0 1 15 7v4c0 1.1.9 2 2 2v8a1 1 0 1 1-2 0v-8c-1.66 0-3-1.34-3-3V7a2.5 2.5 0 0 1 2.5-2.5z"/>
        </svg>
      </div>
      <h1>เพิ่มเมนูสินค้า</h1>
    </div>
    <p class="sub">กรอกข้อมูลและอัปโหลดรูปภาพเมนู จากนั้นกดบันทึก</p>
    <div class="chips" aria-hidden="true">
      <span class="chip">กาแฟ</span>
      <span class="chip">ชา</span>
      <span class="chip">ขนม</span>
      <span class="chip">อาหารจานเดียว</span>
    </div>

    <form id="form">
      <div class="field">
        <label for="shopId">Shop ID</label>
        <input id="shopId" type="text" value="shop_001" required />
      </div>

      <div class="row">
        <div class="field">
          <label for="name">ชื่อเมนู</label>
          <input id="name" type="text" placeholder="กาแฟเย็น" required />
        </div>
        <div class="field">
          <label for="price">ราคา (บาท)</label>
          <input id="price" type="number" inputmode="decimal" min="0" step="0.5" placeholder="45" required />
        </div>
      </div>

      <div class="field">
        <label for="image">รูปภาพเมนู</label>
        <input id="image" type="file" accept="image/*" capture="environment" required />
        <div id="preview" class="preview">
          <img id="previewImg" alt="ตัวอย่างรูปภาพ"/>
          <div>
            <div id="previewName" style="font-weight:600"></div>
            <div id="previewSize" style="color:var(--muted); font-size:12px;"></div>
          </div>
        </div>
      </div>

      <button id="btn" type="submit" class="btn">บันทึกเมนู</button>
      <div id="msg" class="msg" role="status" aria-live="polite"></div>
    </form>

    <footer>ข้อมูลจะถูกส่งไปยังระบบหลังบ้านโดยอัตโนมัติ</footer>
  </main>

<script>
const UPLOAD_BASE = "http://192.168.1.50:8088";
const N8N_BASE = "http://192.168.1.50:5678";

const form = document.getElementById('form');
const msg = document.getElementById('msg');
const btn = document.getElementById('btn');
const imageInput = document.getElementById('image');

// Image preview
imageInput.addEventListener('change', () => {
  const file = imageInput.files && imageInput.files[0];
  const preview = document.getElementById('preview');
  if (!file) { preview.style.display = 'none'; return; }
  const url = URL.createObjectURL(file);
  document.getElementById('previewImg').src = url;
  document.getElementById('previewName').textContent = file.name;
  const sizeKB = Math.round(file.size / 1024);
  document.getElementById('previewSize').textContent = `${sizeKB} KB`;
  preview.style.display = 'flex';
});

form.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  msg.className = 'msg';
  msg.textContent = 'กำลังอัปโหลด...';

  const shopId = document.getElementById('shopId').value.trim();
  const name = document.getElementById('name').value.trim();
  const priceVal = document.getElementById('price').value;
  const price = parseFloat(priceVal);
  const file = imageInput.files && imageInput.files[0];

  if (!shopId || !name || !priceVal || isNaN(price) || price <= 0 || !file) {
    msg.textContent = 'กรอกข้อมูลให้ครบถ้วน และใส่ราคามากกว่า 0';
    msg.classList.add('error');
    return;
  }

  btn.disabled = true;
  try {
    // 1) upload image to upload service
    const fd = new FormData();
    fd.append('file', file);

    const uploadRes = await fetch(`${UPLOAD_BASE}/upload/menu?shopId=${encodeURIComponent(shopId)}`, {
      method: 'POST',
      body: fd
    });

    if (!uploadRes.ok) {
      msg.textContent = 'อัปโหลดรูปภาพล้มเหลว: ' + uploadRes.status;
      msg.classList.add('error');
      return;
    }
    const uploadJson = await uploadRes.json(); // { imageUrl: ... }
    const imageUrl = uploadJson.imageUrl || uploadJson.slipUrl; // เผื่อชื่อ field เป็น slipUrl

    if (!imageUrl) {
      msg.textContent = 'ไม่พบ URL ของรูปภาพจากเซิร์ฟเวอร์';
      msg.classList.add('error');
      return;
    }

    // 2) call n8n to create menu
    const createRes = await fetch(`${N8N_BASE}/webhook/api/menu/create`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ shopId, name, price, imageUrl })
    });

    if (!createRes.ok) {
      const t = await createRes.text();
      msg.textContent = 'สร้างเมนูไม่สำเร็จ: ' + t;
      msg.classList.add('error');
      return;
    }

    msg.textContent = 'บันทึกสำเร็จ ✅';
    msg.classList.add('success');
    form.reset();
    document.getElementById('preview').style.display = 'none';
  } catch (err) {
    console.error(err);
    msg.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ';
    msg.classList.add('error');
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>
